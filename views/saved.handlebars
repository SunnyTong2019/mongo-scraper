<main>

  <nav>
    <div class="nav-wrapper teal">
      <a href="#" class="brand-logo">Mongo Scraper</a>
      <ul class="hide-on-med-and-down">
        <li><a href="/">Home</a></li>
        <li><a href="/saved">Saved Articles</a></li>
      </ul>
    </div>
  </nav>

  <div id="main-section">
    <h1 class="blue-grey-text text-darken-4">Saved Articles</h1>
    <h4 class="blue-grey-text text-darken-4">Your Saved Articles</h4>
    <br>
    <a id="clear-saved-btn" class="red waves-effect waves-light btn">Clear Articles</a>
  </div>


  <div id="no-saved-articles" class="row">
    <div class="col s12">
      <div class="card teal">
        <div class="card-content white-text">
          <span class="card-title">Uh Oh. Looks like we don't have any saved articles.</span>
        </div>
      </div>
    </div>
  </div>

  <div id="saved-articles">

    {{!-- <div class="row article">
    <div class="col s12">
      <div class="card teal">
        <div class="card-content white-text">
          <span class="card-title">I am a very simple card. I am good at containing small bits of information.</span>
          <p>I am a very simple card. I am good at containing small bits of information.
            I am convenient because I require little markup to use effectively.</p>
        </div>
        <div class="card-action">
          <a class="red waves-effect waves-light btn">Delete From Saved</a>
          <a class="red waves-effect waves-light btn" onclick="$('#modal1').modal().modal('open');">Article Notes</a>
        </div>
      </div>
    </div>
  </div>

   <div class="row article">
    <div class="col s12">
      <div class="card teal">
        <div class="card-content white-text">
          <span class="card-title">I am a very simple card. I am good at containing small bits of information.</span>
          <p>I am a very simple card. I am good at containing small bits of information.
            I am convenient because I require little markup to use effectively.</p>
        </div>
        <div class="card-action">
          <a class="red waves-effect waves-light btn">Delete From Saved</a>
          <a class="red waves-effect waves-light btn" onclick="$('#modal1').modal().modal('open');">Article Notes</a>
        </div>
      </div>
    </div>
  </div> --}}

  </div>

  <!-- Modal forms -->
  <div id="notes-modals">

    <!-- <div id="modal1" class="modal">
      <div class="modal-content">
        <h5>Add a note: </h5>
        <div class="row">
          <form>
            <div class="row">
              <div class="input-field col l6 s12">
                <textarea class="materialize-textarea note-body"></textarea>
              </div>
            </div>
            {{!-- <a data-articleid="5dafdba7c6da4c0d69d603dc" class="add-note-btn btn waves-effect waves-light" type="submit">Add</a> --}}
            <button data-articleid="5dafdba7c6da4c0d69d603dc" class="add-note-btn btn waves-effect waves-light"
              type="submit">Add
            </button>
          </form>
        </div>
      </div>
      <div class="modal-footer">
        <a class="modal-action modal-close waves-effect waves-green btn-flat">Close</a>
      </div>
    </div> -->

    <div id="modal2" class="modal">
      <div class="modal-content">

        <div class="note-card card-panel teal">
          <span class="white-text">I am a very simple card.
            I am good at containing small bits of information.
            I am a very simple card.
            I am good at containing small bits of information.
          </span>
          <a class="btn-floating red btn btn-small waves-effect waves-light remove-note-button">
            <i class='material-icons'>delete</i>
          </a>
        </div>

        <div class="note-card card-panel teal">
          <span class="white-text">I am a very simple card.
            I am good at containing small bits of information.
            I am a very simple card.
            I am good at containing small bits of information.
          </span>
          <a class="btn-floating red btn btn-small waves-effect waves-light remove-note-button">
            <i class='material-icons'>delete</i>
          </a>
        </div>
        <br>
        <h5>Add a note: </h5>
        <div class="row">
          <form>
            <div class="row">
              <div class="input-field col l6 s12">
                <textarea class="materialize-textarea"></textarea>
              </div>
            </div>
            <a class="btn waves-effect waves-light">Add</a>
          </form>
        </div>
      </div>
      <div class="modal-footer">
        <a class="modal-action modal-close waves-effect waves-green btn-flat">Close</a>
      </div>
    </div>

  </div>
</main>

<script src="https://code.jquery.com/jquery-3.4.1.min.js"
  integrity="sha256-CSXorXvZcTkaix6Yvo6HppcZGetbYMGWSFlBw8HfCJo=" crossorigin="anonymous"></script>

<!-- Compiled and minified JavaScript -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/materialize/1.0.0/js/materialize.min.js"></script>


<script>

  $.getJSON("/savedArticles", function (data) {
    if (data.length > 0) {
      $("#no-saved-articles").css("display", "none");

      for (var i = 0; i < data.length; i++) {
        var div1 = $("<div>").addClass("row article");
        var div2 = $("<div>").addClass("col s12");
        var div3 = $("<div>").addClass("card teal");
        var div31 = $("<div>").addClass("card-content white-text");
        var articleLink = $("<a>").attr("href", data[i].link);
        var span = $("<span>").addClass("card-title white-text").text(data[i].title);
        articleLink.append(span);
        var p = $("<p>").text(data[i].summary);
        div31.append(articleLink, p);
        var div32 = $("<div>").addClass("card-action");
        var deleteSavedArticleBtn = $("<a>").addClass("delete-saved-btn red waves-effect waves-light btn").attr("data-articleid", data[i]._id).text("Delete From Saved");
        var notesBtn = $("<a>").addClass("notes-btn red waves-effect waves-light btn").attr("data-articleid", data[i]._id).text("Article Notes");
        div32.append(deleteSavedArticleBtn, notesBtn);
        div3.append(div31, div32);
        div2.append(div3);
        div1.append(div2);
        $("#saved-articles").append(div1);
      }
    } else {
      $("#no-saved-articles").css("display", "block");
    }
  });


  $("#clear-saved-btn").click(function () {
    $.ajax({
      url: "/savedArticles",
      type: "DELETE",
      success: function (data) {
        location.reload();
      }
    });
  })


  $(document).on("click", ".delete-saved-btn", function () {
    var articleID = $(this).attr("data-articleid");

    $.ajax({
      url: "/savedArticles/" + articleID,
      type: "DELETE",
      success: function (data) {
        location.reload();
      }
    });
  })


  $(document).on("click", ".notes-btn", function () {
    var articleID = $(this).attr("data-articleid");

    $.getJSON("/savedArticles/" + articleID, function (data) {

      console.log(data);

      var div1 = $("<div>").addClass("modal").attr("id", "modal" + articleID);
      var div2 = $("<div>").addClass("modal-content");

      if (data.notes.length > 0) {
        for (var i = 0; i < data.notes.length; i++) {
          var divA = $("<div>").addClass("note-card card-panel teal");
          var span = $("<span>").addClass("white-text").text(data.notes[i].body);
          var deleteNoteBtn = $("<a>").addClass("btn-floating red btn btn-small waves-effect waves-light remove-note-button").attr("data-noteid", data.notes[i]._id);
          var deleteIcon = $("<i>").addClass("material-icons").text("delete");
          deleteNoteBtn.append(deleteIcon);
          divA.append(span, deleteNoteBtn);
          div2.append(divA);
        }
      }

      var h5 = $("<h5>").text("Add a note:");
      var div21 = $("<div>").addClass("row");
      var form = $("<form>");
      var div211 = $("<div>").addClass("row");
      var div2111 = $("<div>").addClass("input-field col l6 s12");
      var textArea = $("<textarea>").addClass("materialize-textarea note-body");
      var addNoteBtn = $("<button>").addClass("add-note-btn btn waves-effect waves-light").attr("data-articleid", articleID).attr("type", "submit").text("Add");
      var div3 = $("<div>").addClass("modal-footer");
      var closeModalBtn = $("<a>").addClass("modal-action green modal-close waves-effect waves-green btn-flat").text("Close")
      div3.append(closeModalBtn);
      div2111.append(textArea);
      div211.append(div2111);
      form.append(div211, addNoteBtn);
      div21.append(form);
      div2.append($("<br>"), h5, div21);
      div1.append(div2, div3);
      $("#notes-modals").append(div1);
      $('#modal' + articleID).modal().modal('open');
    });
  })


  $(document).on("click", ".add-note-btn", function (event) {
    event.preventDefault();

    var articleID = $(this).attr("data-articleid");
    //console.log(articleID);
    //console.log($(".note-body").val().trim())

    $.ajax({
      method: "POST",
      url: "/savedArticles/" + articleID,
      data: {
        body: $(".note-body").val().trim()
      }
    }).then(function (data) {
      //$('#modal' + articleID).modal('close');
      location.reload();
    });

  })


  $(document).on("click", ".remove-note-button", function () {
    var noteID = $(this).attr("data-noteid");

    $.ajax({
      url: "/notes/" + noteID,
      type: "DELETE",
      success: function (data) {
        location.reload();
      }
    });
  })

</script>